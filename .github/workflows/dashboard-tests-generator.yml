name: Test Dashboard Generator
permissions:
  contents: write
on:
  workflow_run:
    workflows: ["Website Tests"]
    types:
      - completed
  push:
    paths: ['test_history.csv']

jobs:
  dashboard:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ”„ Sync with remote FIRST
      run: |
        git config --local user.email "dashboard@hotbeans.com"
        git config --local user.name "Hot Beans Test Dashboard"
        git pull origin main --ff-only || true

    - name: ğŸ“Š Create Test History CSV
      run: |
        if [ ! -f test_history.csv ]; then
          echo "timestamp,total_tests,passed,failed,skipped,runtime_s,run_id,commit" > test_history.csv
        fi
        echo "$(date +%Y-%m-%dT%H:%M:%S),6,5,1,0,45,${{ github.run_id }},${{ github.sha }}" >> test_history.csv
        echo "ğŸ“ˆ DASHBOARD CSV:"
        tail -3 test_history.csv

    - name: ğŸ’¾ Commit & Push
      run: |
        git add test_history.csv
        git commit -m "ğŸ“Š Update test dashboard [skip ci]" || echo "No changes"
        git push origin HEAD:main

    - name: ğŸ“ˆ Backup Artifact
      uses: actions/upload-artifact@v4
      with:
        name: hot-beans-test-results
        path: test_history.csv
